<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GearGen Demo — Interactive</title>

<!-- Bootstrap for quick layout -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  :root{
    --bg:#f7f9fb; --card:#ffffff; --accent:#0d6efd; --muted:#6c757d;
  }
  body{font-family:Inter,system-ui,Arial; background:var(--bg); color:#222; padding:28px;}
  .demo-row{display:flex; gap:20px; align-items:flex-start; justify-content:center; flex-wrap:wrap;}
  .mock { width:320px; background:var(--card); border-radius:12px; box-shadow:0 8px 24px rgba(20,30,40,.08); padding:16px; }
  .mock h6 { font-weight:700; margin-bottom:8px; font-size:14px; }
  .input-field label{font-size:13px; color:var(--muted); font-weight:600;}
  .input-field input{width:100%; margin-top:6px;}
  .gen-btn{margin-top:12px;}
  #svgCad{width:100%; height:320px; background:#fff; border-radius:8px; border:1px dashed #e6eef6; display:flex; align-items:center; justify-content:center; overflow:hidden;}
  #preview3d{ width:100%; height:320px; background:linear-gradient(180deg,#20232b,#111416); border-radius:8px; overflow:hidden; }
  .caption { font-size:13px; margin-top:10px; color:#444; text-align:center; font-weight:600; }
  .subcap { font-size:12px; color:var(--muted); text-align:center; margin-top:6px;}
  /* responsive */
  @media (max-width:980px){
    .demo-row{flex-direction:column; align-items:center;}
  }
</style>
</head>
<body>

<div class="container">
  <h2 class="mb-3">GearGen Demo — Interactive Prototype</h2>
  <p class="text-muted">Enter simple gear parameters and click <strong>Generate</strong>. The demo shows a 2D CAD drawing (SVG) and an interactive 3D preview (client-side).</p>

  <div class="demo-row mt-4">
    <!-- Input card -->
    <div class="mock">
      <h6>Mockup 1: Input Interface</h6>
      <div class="input-field mb-2">
        <label>Torque (N·m)</label>
        <input id="torque" class="form-control form-control-sm" type="number" value="100">
      </div>
      <div class="input-field mb-2">
        <label>RPM</label>
        <input id="rpm" class="form-control form-control-sm" type="number" value="1500">
      </div>
      <div class="input-field mb-2">
        <label>Gear ratio (z2 : z1)</label>
        <input id="ratio" class="form-control form-control-sm" type="text" value="3:1">
      </div>
      <div class="input-field mb-2">
        <label>Module (mm)</label>
        <input id="module" class="form-control form-control-sm" type="number" value="2">
      </div>
      <div class="input-field mb-2">
        <label>Teeth on pinion (z1) — optional</label>
        <input id="z1" class="form-control form-control-sm" type="number" placeholder="Auto">
      </div>

      <div class="d-grid">
        <button id="generateBtn" class="btn btn-primary gen-btn">Generate Gear</button>
      </div>

      <div class="mt-3">
        <small class="text-muted">Outputs: pitch diameter, center distance, SVG CAD drawing, and a 3D model preview (export planned).</small>
      </div>
    </div>

    <!-- SVG CAD drawing card -->
    <div class="mock">
      <h6>Mockup 2: Generated CAD Drawing (spur gear)</h6>
      <div id="svgCad" aria-live="polite" role="img">
        <!-- SVG inserted here -->
      </div>
      <div class="caption">2D CAD preview (SVG)</div>
      <div class="subcap">Right-click the SVG to save or use "Download SVG" button below.</div>
      <div class="d-flex gap-2 mt-2">
        <button id="downloadSvg" class="btn btn-outline-secondary btn-sm">Download SVG</button>
        <button id="downloadCsv" class="btn btn-outline-secondary btn-sm">Download CSV</button>
      </div>
    </div>

    <!-- 3D preview card -->
    <div class="mock">
      <h6>Mockup 3: 3D Model Preview</h6>
      <div id="preview3d"></div>
      <div class="caption">Interactive 3D preview (rotate / zoom)</div>
      <div class="subcap">Use mouse to rotate. This is a client-side extruded gear model for demo only.</div>
      <div class="d-flex gap-2 mt-2">
        <button id="downloadPng" class="btn btn-outline-secondary btn-sm">Download PNG</button>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/OrbitControls.js"></script>

<script>
/* ---------- gear math + svg generator ---------- */

/** compute gear parameters
 *  ratioInput like "3:1" or "2" => numeric ratio (z2/z1)
 */
function parseRatio(r) {
  r = (''+r).trim();
  if (r.includes(':')) {
    const [a,b] = r.split(':').map(s=>Number(s));
    if (!isNaN(a) && !isNaN(b) && b!==0) return a/b;
  }
  const n = Number(r);
  return (isNaN(n) || n===0) ? 2 : n;
}

function compute(params) {
  let { torque, rpm, ratioInput, module, z1 } = params;
  torque = Number(torque)||0; rpm = Number(rpm)||0; module = Number(module)||2;
  const ratio = parseRatio(ratioInput);
  if (!z1) {
    // select z1 that makes z2 integer and keeps z1 between 12..40
    let chosen = 20;
    for (let cand=12; cand<=40; cand++){
      const z2 = Math.round(cand * ratio);
      if (Math.abs(z2/cand - ratio) < 1e-6) { chosen = cand; break; }
    }
    z1 = chosen;
  } else z1 = Math.max(8, Math.round(Number(z1)));
  const z2 = Math.round(z1 * ratio);
  const pd1 = module * z1;
  const pd2 = module * z2;
  const center = (pd1 + pd2) / 2;
  return { torque, rpm, ratio, module, z1, z2, pd1:pd1.toFixed(2), pd2:pd2.toFixed(2), center:center.toFixed(2) };
}

/** create an SVG spur gear path approximation
 *  teeth: number of teeth
 *  module: used for pitch diameter scaling
 */
function createGearSVG(teeth, module, bore=20) {
  const pd = teeth * module;    // pitch diameter (mm)
  const R = pd/2;
  const outer = R + module*0.6;
  const inner = R - module*0.6;
  const toothAngle = (2*Math.PI)/teeth;
  const svgNS = "http://www.w3.org/2000/svg";
  const svg = document.createElementNS(svgNS,'svg');
  const size = Math.max(360, outer*3);
  svg.setAttribute('viewBox', `${-size/2} ${-size/2} ${size} ${size}`);
  svg.setAttribute('width','100%'); svg.setAttribute('height','100%');

  // gear body group
  const g = document.createElementNS(svgNS,'g');

  // draw teeth as simple arcs/polygons
  for (let i=0;i<teeth;i++){
    const a = i*toothAngle;
    const a1 = a + 0.18*toothAngle;
    const a2 = a - 0.18*toothAngle;
    const x1 = outer*Math.cos(a2), y1 = outer*Math.sin(a2);
    const x2 = outer*Math.cos(a1), y2 = outer*Math.sin(a1);
    const x3 = inner*Math.cos(a1), y3 = inner*Math.sin(a1);
    const x4 = inner*Math.cos(a2), y4 = inner*Math.sin(a2);
    const path = document.createElementNS(svgNS,'path');
    path.setAttribute('d',`M ${x1} ${y1} L ${x2} ${y2} L ${x3} ${y3} L ${x4} ${y4} Z`);
    path.setAttribute('fill','#e6eef6');
    path.setAttribute('stroke','#2b2f34');
    path.setAttribute('stroke-width','1');
    g.appendChild(path);
  }

  // inner hub circle
  const hub = document.createElementNS(svgNS,'circle');
  hub.setAttribute('cx','0'); hub.setAttribute('cy','0'); hub.setAttribute('r',Math.max(12,bore));
  hub.setAttribute('fill','#ffffff'); hub.setAttribute('stroke','#111');
  g.appendChild(hub);

  // center crosshair
  const cross = document.createElementNS(svgNS,'g');
  const l1 = document.createElementNS(svgNS,'line');
  l1.setAttribute('x1',-10); l1.setAttribute('y1',0); l1.setAttribute('x2',10); l1.setAttribute('y2',0);
  l1.setAttribute('stroke','#333'); l1.setAttribute('stroke-width',1);
  cross.appendChild(l1);
  const l2 = document.createElementNS(svgNS,'line');
  l2.setAttribute('x1',0); l2.setAttribute('y1',-10); l2.setAttribute('x2',0); l2.setAttribute('y2',10);
  l2.setAttribute('stroke','#333'); l2.setAttribute('stroke-width',1);
  cross.appendChild(l2);

  svg.appendChild(g);
  svg.appendChild(cross);

  // small label showing PD
  const text = document.createElementNS(svgNS,'text');
  text.setAttribute('x', -size/2 + 12);
  text.setAttribute('y', -size/2 + 22);
  text.setAttribute('font-size',12);
  text.setAttribute('fill','#333');
  text.textContent = `Teeth: ${teeth} • Module: ${module} • PD: ${pd.toFixed(2)} mm`;
  svg.appendChild(text);

  return svg;
}

/* ---------- CSV / SVG download helpers ---------- */
function downloadText(name, content, mime='text/plain') {
  const blob = new Blob([content],{type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = name; a.click();
  URL.revokeObjectURL(url);
}

/* ---------- 3D preview (Three.js) ---------- */
let renderer, scene, camera, controls, threeGear;
function init3D(container) {
  // clear container
  container.innerHTML = '';
  renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
  renderer.setSize(container.clientWidth, container.clientHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  container.appendChild(renderer.domElement);

  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(40, container.clientWidth/container.clientHeight, 0.1, 2000);
  camera.position.set(0,120,300);

  controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  // lights
  const hemi = new THREE.HemisphereLight(0xffffff, 0x222222, 0.6);
  scene.add(hemi);
  const dir = new THREE.DirectionalLight(0xffffff, 0.8);
  dir.position.set(200,300,200);
  scene.add(dir);

  // floor reflection (subtle)
  const plane = new THREE.Mesh(new THREE.PlaneGeometry(2000,2000), new THREE.MeshBasicMaterial({color:0x0c0d0e,opacity:0.0,transparent:true}));
  plane.rotation.x = -Math.PI/2; plane.position.y = -200;
  scene.add(plane);

  window.addEventListener('resize', ()=> {
    renderer.setSize(container.clientWidth, container.clientHeight);
    camera.aspect = container.clientWidth/container.clientHeight;
    camera.updateProjectionMatrix();
  });

  animate();
}
function animate() {
  requestAnimationFrame(animate);
  if (controls) controls.update();
  renderer.render(scene, camera);
}

/** build a simple extruded gear geometry by creating a 2D path of teeth */
function buildGearMesh(teeth, module, thickness=24, bore=12) {
  // pitch radius (px-like units) scale factor
  const scale = 4.0;
  const pd = teeth * module;
  const R = (pd/2) * scale;
  const outerR = R + module*scale*0.6;
  const innerR = R - module*scale*0.6;
  const shape = new THREE.Shape();

  // create tooth points (approx polygon) going around
  const toothAngle = (2*Math.PI)/teeth;
  const points = [];
  for (let i=0;i<teeth;i++){
    const a = i*toothAngle;
    const a2 = a - 0.18*toothAngle;
    const a1 = a + 0.18*toothAngle;
    // push outer then inner arc points to form teeth loop
    points.push(new THREE.Vector2(outerR*Math.cos(a2), outerR*Math.sin(a2)));
    points.push(new THREE.Vector2(outerR*Math.cos(a1), outerR*Math.sin(a1)));
    points.push(new THREE.Vector2(innerR*Math.cos(a1), innerR*Math.sin(a1)));
    points.push(new THREE.Vector2(innerR*Math.cos(a2), innerR*Math.sin(a2)));
  }
  // move to first point, draw shape
  shape.moveTo(points[0].x, points[0].y);
  for (let p=1;p<points.length;p++) shape.lineTo(points[p].x, points[p].y);
  shape.closePath();

  // subtract center hole using a Path
  const hole = new THREE.Path();
  const holeR = Math.max(8, bore) * scale;
  const segments = 32;
  for (let i=0;i<segments;i++){
    const a = (i/segments) * Math.PI*2;
    const x = holeR*Math.cos(a), y = holeR*Math.sin(a);
    if (i===0) hole.moveTo(x,y); else hole.lineTo(x,y);
  }
  hole.closePath();
  shape.holes.push(hole);

  // extrude geometry
  const extrudeSettings = { depth: thickness, bevelEnabled:true, bevelThickness:1, bevelSize:1.5, bevelSegments:2 };
  const geom = new THREE.ExtrudeGeometry(shape, extrudeSettings);
  geom.center(); // center geometry
  // material: metallic
  const mat = new THREE.MeshStandardMaterial({ color:0xbfc8cf, metalness:0.9, roughness:0.25, envMapIntensity:0.8 });
  const mesh = new THREE.Mesh(geom, mat);
  // rotate so face is upright
  mesh.rotation.x = -Math.PI/2;
  return mesh;
}

/* ---------- wiring UI ---------- */
const svgHolder = document.getElementById('svgCad');
const previewHolder = document.getElementById('preview3d');
const generateBtn = document.getElementById('generateBtn');
const downloadSvgBtn = document.getElementById('downloadSvg');
const downloadCsvBtn = document.getElementById('downloadCsv');
const downloadPngBtn = document.getElementById('downloadPng');

init3D(previewHolder);

// helper to clear and set svg
function setSvg(node) {
  svgHolder.innerHTML = '';
  svgHolder.appendChild(node);
}

function renderAll() {
  const params = {
    torque: document.getElementById('torque').value,
    rpm: document.getElementById('rpm').value,
    ratioInput: document.getElementById('ratio').value,
    module: document.getElementById('module').value,
    z1: document.getElementById('z1').value || null
  };
  const res = compute(params);
  // generate svg
  const svg = createGearSVG(res.z2, res.module);
  setSvg(svg);

  // download CSV content builder
  const csvText = `parameter,value
torque,${res.torque}
rpm,${res.rpm}
z1,${res.z1}
z2,${res.z2}
module,${res.module}
pd1_mm,${res.pd1}
pd2_mm,${res.pd2}
center_mm,${res.center}
`;
  // attach csv to button via closure
  downloadCsvBtn.onclick = ()=> downloadText('geargen_result.csv', csvText, 'text/csv');

  // attach svg download
  downloadSvgBtn.onclick = ()=> {
    const ser = new XMLSerializer();
    const str = ser.serializeToString(svg);
    downloadText('gear_drawing.svg', str, 'image/svg+xml');
  };

  // generate 3D mesh and replace existing
  if (threeGear) { scene.remove(threeGear); threeGear.geometry && threeGear.geometry.dispose(); threeGear.material && threeGear.material.dispose(); threeGear = null; }
  threeGear = buildGearMesh(res.z2, res.module, 18, 12);
  // add subtle base
  const baseGeom = new THREE.CylinderGeometry(500,500,1,6); const baseMat=new THREE.MeshStandardMaterial({color:0x0b0b0c,metalness:0.2,roughness:0.8});
  const base = new THREE.Mesh(baseGeom, baseMat); base.position.y = -90;
  scene.add(base);

  threeGear.position.y = 0; scene.add(threeGear);

  // make sure camera frames gear
  const box = new THREE.Box3().setFromObject(threeGear);
  const size = box.getSize(new THREE.Vector3()).length();
  const center = box.getCenter(new THREE.Vector3());
  controls.target.copy(center);
  camera.position.set(center.x, center.y + Math.max(size*0.5, 120), center.z + Math.max(size*0.9, 240));
  camera.updateProjectionMatrix();
}

// initial render
renderAll();

generateBtn.addEventListener('click', renderAll);

// download preview as png
downloadPngBtn.addEventListener('click', ()=> {
  // render to canvas image from three renderer
  renderer.render(scene, camera);
  const url = renderer.domElement.toDataURL('image/png');
  const a = document.createElement('a'); a.href=url; a.download='gear_preview.png'; a.click();
});

</script>
</body>
</html>
